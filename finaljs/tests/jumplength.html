<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script type="text/javascript" src="../3rd/Box2d.min.js"></script>
    <style type="text/css">
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
<canvas id="playground" width="600" height="400" tabindex="1"></canvas>
<script type="text/javascript">
    (function () {
        var b2Vec2 = Box2D.Common.Math.b2Vec2,
                b2BodyDef = Box2D.Dynamics.b2BodyDef,
                b2Body = Box2D.Dynamics.b2Body,
                b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
                b2World = Box2D.Dynamics.b2World,
                b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
                b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
                b2DebugDraw = Box2D.Dynamics.b2DebugDraw;

        var FRAMETIME = 1.0 / 60.0;
        var ONE_FRAME_SEC = FRAMETIME * 60;

        var canvas = document.getElementById("playground");
        var ctx = canvas.getContext("2d");

        var keystate = [];

        canvas.addEventListener("keydown", function (e) {
            keystate[e.keyCode] = true;
        }, false);
        canvas.addEventListener("keyup", function (e) {
            keystate[e.keyCode] = false;
        }, false);

        function isKeyDown(keyCode) {
            return typeof keystate[keyCode] != "undefined" && keystate[keyCode];
        }

        var PlayerGroundSensor = 10;

        function Player(world) {
            var bodyDef = new b2BodyDef;
            bodyDef.type = b2Body.b2_dynamicBody;
            bodyDef.position.Set(0, 0);
            bodyDef.fixedRotation = true;
            this.body = world.CreateBody(bodyDef);

            var fixDef = new b2FixtureDef;
            fixDef.density = 1.0;
            fixDef.friction = 0.5;
            fixDef.restitution = 0;
            fixDef.userData = PlayerGroundSensor;
            fixDef.shape = new b2PolygonShape();
            fixDef.shape.SetAsBox(0.5, 1);
            this.body.CreateFixture(fixDef);

            fixDef.shape = new b2PolygonShape();
            fixDef.shape.m_centroid.Set(0, 2);
            fixDef.shape.SetAsBox(0.25, 0.15);
            for (var i = 0; i < 4; i++) {
                fixDef.shape.m_vertices[i].y += 1;
            }
            fixDef.isSensor = true;
            this.body.CreateFixture(fixDef);

            this.groundsensorCounter = 0;
            this.jumpKeyDown = false;
            this.jumpActive = false;
            this.jumpRemain = 0;
            this.jumpPower = 3;
        }

        Player.prototype.update = function(dt){
            var onground = this.groundsensorCounter > 0;

            var pos, impulse;

            // Left rigth
            if (isKeyDown(37)) {
                pos = this.body.GetPosition();
                impulse = new b2Vec2(-0.2, 0);
                this.body.ApplyImpulse(impulse, pos);
            } else if (isKeyDown(39)) {
                pos = this.body.GetPosition();
                impulse = new b2Vec2(0.2, 0);
                this.body.ApplyImpulse(impulse, pos);
            }

            if (isKeyDown(32)) {
                if (!this.jumpKeyDown && onground) {
                    // Initial jump start
                    this.jumpKeyDown = true;
                    this.jumpActive = true;
                    this.jumpRemain = ONE_FRAME_SEC / 10; // Allow jump a tenth of a second
                } else {
                    // Jump key hold
                }
            } else {
                if (this.jumpKeyDown) {
                    // Released jump key
                    this.jumpKeyDown = false;
                    this.jumpActive = false;
                }
            }

            if (this.jumpActive && this.jumpRemain > 0) {
                this.jumpRemain -= dt;
                if (this.jumpRemain < 0) {
                    this.jumpRemain = 0;
                    this.jumpActive = false;
                }
                pos = this.body.GetPosition();
                impulse = new b2Vec2(0, -1 * this.jumpPower);
                this.body.ApplyImpulse(impulse, pos);
            }
        };

        Player.prototype.BeginContact = function(contact) {
            if (contact.m_fixtureA.IsSensor() && !contact.m_fixtureB.IsSensor()) {
                if (contact.m_fixtureA.GetUserData() === PlayerGroundSensor) {
                    this.groundsensorCounter++;
                }
            } else if (!contact.m_fixtureA.IsSensor() && contact.m_fixtureB.IsSensor()) {
                if (contact.m_fixtureB.GetUserData() === PlayerGroundSensor) {
                    this.groundsensorCounter++;
                }
            }
        };

        Player.prototype.EndContact = function(contact) {
            if (contact.m_fixtureA.IsSensor() && !contact.m_fixtureB.IsSensor()) {
                if (contact.m_fixtureA.GetUserData() === PlayerGroundSensor) {
                    this.groundsensorCounter = Math.max(0, this.groundsensorCounter - 1);
                }
            } else if (!contact.m_fixtureA.IsSensor() && contact.m_fixtureB.IsSensor()) {
                if (contact.m_fixtureB.GetUserData() === PlayerGroundSensor) {
                    this.groundsensorCounter = Math.max(0, this.groundsensorCounter - 1);
                }
            }
        };

        Player.prototype.PreSolve = function() {
        };

        Player.prototype.PostSolve = function() {
        };

        var world = new b2World(
                new b2Vec2(0, 10), //gravity vector
                true
        );

        var fixDef = new b2FixtureDef;
        fixDef.density = 1.0;
        fixDef.friction = 0.2;
        fixDef.restitution = 0;

        var bodyDef = new b2BodyDef;

        var debugDraw = new b2DebugDraw();
        debugDraw.SetSprite(ctx);
        debugDraw.SetDrawScale(20.0);
        debugDraw.SetFillAlpha(0.5);
        debugDraw.SetLineThickness(1.0);
        debugDraw.SetFlags(b2DebugDraw.e_shapeBit);
        world.SetDebugDraw(debugDraw);

        // Create static boxes
        bodyDef.type = b2Body.b2_staticBody;
        fixDef.shape = new b2PolygonShape();
        fixDef.shape.SetAsBox(10, 0.5);
        bodyDef.position.Set(0, 8);
        world.CreateBody(bodyDef).CreateFixture(fixDef);
        bodyDef.position.Set(0, -8);
        world.CreateBody(bodyDef).CreateFixture(fixDef);
        bodyDef.position.Set(-10, 0);
        fixDef.shape.SetAsBox(0.5, 8);
        world.CreateBody(bodyDef).CreateFixture(fixDef);
        bodyDef.position.Set(10, 0);
        world.CreateBody(bodyDef).CreateFixture(fixDef);

        // Create player
        var player = new Player(world);

        world.SetContactListener(player);

        var lastTime = 0;
        var accumulatedTime = 0;

        var frameRequest = function(msecs){
            var startTime = (msecs / 1000.0);
            var deltaTime = startTime - lastTime;
            if (deltaTime > 1.0) {
                deltaTime = 1.0;
            }
            lastTime = startTime;

            accumulatedTime += deltaTime;

            while (accumulatedTime > FRAMETIME) {
                accumulatedTime -= FRAMETIME;
                player.update(FRAMETIME);
                world.Step(FRAMETIME, 10, 10);
                world.ClearForces();
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width * 0.5, canvas.height * 0.5);
            world.DrawDebugData();
            ctx.restore();
            requestAnimationFrame(frameRequest);
        };
        requestAnimationFrame(frameRequest);
   })();
</script>
</body>
</html>